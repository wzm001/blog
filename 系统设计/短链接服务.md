# 设计一个短链接服务

## 1. 明确需求

### 什么是短链接服务（URL Shortening Service）
> 短链接服务是一个重定向服务；基本功能是将长链接关联到一个短链接上，当客户端访问短链接时，服务端返回一个 302 临时重定向，将请求重定向到原始链接。

*为什么不使用 301 重定向*
> 301 是永久重定向，浏览器会缓存重定向后的目标地址，下一次访问时会绕过短链接直接访问目标地址，而且搜索引擎也会保存重定向后的地址，这样短链接服务就失效了；
> 302 是临时重定向，浏览器不会缓存目标地址，搜索引擎也会记录当前端链接；
> 302 有网址劫持的问题；

### 为什么需要短链接服务？
1. 减少链接长度；减少长度可以方便记忆，或者通过短信等有字数限制的场景下发送链接，或者生成清晰的二维码；
2. 隐藏原始链接；有些系统的原始链接可能包含了敏感信息，通过短链接可以隐藏这些信息；
3. 可以定制个性化链接；
4. 可以通过短链接服务，统计链接访问的相关信息；
5. 可以通过短链接服务，控制原始链接的访问；如次数限制、访问限制等；

### 具体需求

#### 功能需求：
  * 给定一个URL，可以生成对应的短链接URL；
  * 当用户访问短链接时，可以返回给客户端原始链接的重定向；
  * 用户可以指定一个字符串作为个性化短链接（不包括域名）；
  * 短链接经过一定的时间会失效，此时访问返回 404；

#### 非功能需求：
  * 服务必须高可用；如果服务挂了，所有的短链接都会失效，造成的损失是难以估量的；
  * 服务需要低延迟；
  * 短链接无法被破解和推测；

#### 扩展需求：
  * 访问数据的分析和统计；
  * 管理界面和风控，为防止给非法网站生成短链接，需要有相关措施加以控制；（审核、批量失效、拉黑用户等）

## 2. 粗略估算容量和负载

短链接服务是一个读多写少的服务。重定向的请求数量要远远高于添加短链接的请求数量。这里，让我们假设读写请求数的比例为 **100:1**。

### 估算负载

假设短链接服务每月有 *5亿* 次写请求，根据我们预设的读写比例，则每月将有 *500亿* 次读请求；
可以推算出写请求的QPS约为200，即每秒有大约200次写请求，同理，根据读写比，读请求的QPS为20000；

### 存储估算

假设用户创建的短链接最长有效期为5年，按照每月5亿次写请求估算，服务需要存储 500M * 12 * 5 = 300亿 条数据；
假设每条数据粗略估算大小为500字节，则需要 *15TB* 的存储空间；

### 带宽估算

按照200的写QPS估算，写请求的带宽为 500B * 200 = 100KB/s；
同理，读请求的带宽为 100KB/s * 100 = 10MB/s；

### 内存估算

为提高服务性能，有必要把热点URL缓存下来，按照二八原则，系统中20%的URL贡献了80%的流量。
如果我们要把这20%的热点URL缓存下来，假设缓存时间为1天，按照20000的QPS估算，则每天需要的内存为 20000 * 3600 * 24 * 500B * 20% ～= 170GB；
需要注意，由于会有很多请求访问同一个URL，所以实际中不会用到这么多的内存；

### 总结
| 创建URL | 200/s

